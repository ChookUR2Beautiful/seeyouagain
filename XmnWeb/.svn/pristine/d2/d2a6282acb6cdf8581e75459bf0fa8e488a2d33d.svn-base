/*!
 * ZUI - v1.2.0-beta - 2014-10-30
 * http://zui.sexy
 * GitHub: https://github.com/easysoft/zui.git 
 * Copyright (c) 2014 cnezsoft.com; Licensed MIT
 */

+function(a,b){"use strict";var c="zui.calendar",d=function(a,b){b=b||1;for(var c=a.clone();c.getDay()!=b;)c.addDays(-1);return c.setHours(0),c.setMinutes(0),c.setSeconds(0),c.setMilliseconds(0),c},e=function(a){var b=a.clone();return b.setDate(1),b},f=function(a){var b=a.clone(),c=b.getMonth();for(b.setDate(28);b.getMonth()==c;)b.addDays(1);return b.addDays(-1),b},g=function(d,e){if(this.name=c,this.$=a(d),this.id=this.$.attr("id")||c+a.uuid(),this.$.attr("id",this.id),this.storeName=c+"."+this.id,this.getOptions(e),this.getLang(),this.data=this.options.data,this.calendars=a.isPlainObject(this.data.calendars)?this.data.calendars:{},this.events=this.data.events,this.sortEvents(),this.storeData=b.store.pageGet(this.storeName,{date:"today",view:"month"}),this.date=this.options.startDate||(this.options.storage?this.storeData.date:"today"),this.view=this.options.startView||(this.options.storage?this.storeData.view:"month"),this.$.toggleClass("limit-event-title",e.limitEventTitle),this.options.withHeader){var f=this.$.children(".calender-header");f.length||(f=a('<header><div class="btn-toolbar"><div class="btn-group"><button type="button" class="btn btn-today">{today}</button></div><div class="btn-group"><button type="button" class="btn btn-prev"><i class="icon-chevron-left"></i></button><button type="button" class="btn btn-next"><i class="icon-chevron-right"></i></button></div><div class="btn-group"><span class="calendar-caption"></span></div></div></header>'.format(this.lang)),this.$.append(f)),this.$caption=f.find(".calendar-caption"),this.$todayBtn=f.find(".btn-today"),this.$header=f}var g=this.$.children(".calendar-views");g.length||(g=a('<div class="calendar-views"></div>'),this.$.append(g)),this.$views=g,this.$monthView=g.children(".calendar-view.month"),this.display(),this.bindEvents()};g.DEFAULTS={langs:{zh_cn:{weekNames:["周一","周二","周三","周四","周五","周六","周日"],monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],today:"今天",year:"{0}年",month:"{0}月",yearMonth:"{0}年{1}月"}},data:{calendars:{defaultCal:{color:"#229F24"}},events:[]},limitEventTitle:!0,storage:!0,withHeader:!0,dragThenDrop:!0},g.prototype.sortEvents=function(){var b=this.events;a.isArray(b)||(b=[]),a.each(b,function(b,c){"string"==typeof c.start&&(c.start=new Date(c.start)),"string"==typeof c.end&&(c.end=new Date(c.end)),"undefined"==typeof c.id&&(c.id=a.uuid())}),b.sort(function(a,b){return a.start>b.start?1:a.start<b.start?-1:0})},g.prototype.bindEvents=function(){var b=this.$,c=this;b.on("click",".btn-today",function(){c.date=new Date,c.display(),c.callEvent("clickTodayBtn")}).on("click",".btn-next",function(){"month"===c.view&&c.date.addMonths(1),c.display(),c.callEvent("clickNextBtn")}).on("click",".btn-prev",function(){"month"===c.view&&c.date.addMonths(-1),c.display(),c.callEvent("clickPrevBtn")}).on("click",".event",function(b){c.callEvent("clickEvent",{event:a(this).data("event"),events:c.events}),b.stopPropagation()}).on("click",".cell-day",function(){c.callEvent("clickCell",{view:c.view,date:a(this).attr("data-date"),events:c.events})})},g.prototype.addCalendars=function(b){a.isPlainObject(b)&&(b=[b]),a.each(b,function(a,b){this.callEvent("beforeAddCalendars",{newCalendar:b,data:this.data})&&this.calendars[b.name](b)}),this.display(),this.callEvent("addCalendars",{newCalendars:b,data:this.data})},g.prototype.addEvents=function(b){a.isPlainObject(b)&&(b=[b]),a.each(b,function(a,b){this.callEvent("beforeAddEvent",{newEvent:b,data:this.data})&&this.events.push(b)}),this.sortEvents(),this.display(),this.callEvent("addEvents",{newEvents:b,data:this.data})},g.prototype.getEvent=function(a){for(var b=this.events,c=0;c<b.length;c++)if(b[c].id==a)return b[c];return null},g.prototype.updateEvents=function(){var b={data:this.data,changes:[]};a.isPlainObject(events)&&(events=[events]);var c,d,e;a.each(events,function(f,g){c=g.event,d=g.changes,e={event:c,changes:[]},"string"==typeof c&&(c=this.getEvent(c)),c&&(a.isPlainObject(d)&&(d=[d]),a.each(function(b,d){this.callEvent("beforeChange",{event:c,change:d.change,to:d.to,from:c[d.change]})&&(e.changes.push(a.entend(!0,{},d,{from:c[d.change]})),c[d.change]=d.to)})),b.changes.push(e)}),this.sortEvents(),this.display(),this.callEvent("change",b)},g.prototype.removeEvents=function(b){a.isArray(b)||(b=[b]);var c,d,e,f=this.events,g=[];a.each(b,function(b,h){c=a.isPlainObject(h)?h.id:h,e=-1;for(var i=0;i<f.length;i++)if(f[i].id==c){e=i,d=f[i];break}e>=0&&this.callEvent("beforeRemoveEvent",{event:d,eventId:c,data:this.data})&&(f.splice(e,1),g.push(d))}),this.sortEvents(),this.display(),this.callEvent("removeEvents",{removedEvents:g,data:this.data})},g.prototype.getOptions=function(b){this.options=a.extend({},g.DEFAULTS,this.$.data(),b)},g.prototype.getLang=function(){this.lang=this.options.langs[this.options.lang||a.clientLang()]},g.prototype.display=function(a,c){"undefined"==typeof a?a=this.view:this.view=a,"undefined"==typeof c?c=this.date:this.date=c,"today"===c?(c=new Date,this.date=c):"string"==typeof c&&(c=new Date(c),this.date=c),this.options.storage&&b.store.pageSet(this.storeName,{date:c,view:a});var d={view:a,date:c};if(this.callEvent("beforeDisplay",d)){switch(a){case"month":this.displayMonth(c)}this.callEvent("display",d)}},g.prototype.displayMonth=function(){var b=this.options,c=this,g=this.lang,h=this.date,i=this.$views,j=this.$,k=c.$monthView;if(!k.length){k=a('<div class="calendar-view month"><table class="table table-bordered"><thead><tr class="week-head"></tr></thead><tbody class="month-days"></tbody></table></div>');for(var l,m=k.find(".week-head"),n=k.find(".month-days"),o=0;7>o;o++)m.append("<th>"+g.weekNames[o]+"</th>");for(var o=0;6>o;o++){l=a('<tr class="week-days"></tr>');for(var p=0;7>p;p++)l.append('<td class="cell-day"><div class="day"><div class="heading"><span class="month"></span> <span class="number"></span></div><div class="content"><div class="events"></div></div></div></td>');n.append(l)}i.append(k),c.$monthView=k}var q,r,s,t,u,v,w=k.find(".week-days"),x=k.find(".day"),y=e(h),z=(f(h),new Date),A=d(y),B=h.getFullYear(),C=h.getMonth(),D=(h.getDate(),z.getMonth()),E=z.getFullYear(),F=z.getDate(),G=A.clone().addDays(42).addMilliseconds(-1),H=A.clone().addDays(1).addMilliseconds(-1);w.each(function(b){q=a(this),q.find(".day").each(function(c){r=a(this),s=r.closest(".cell-day"),t=H.getFullYear(),u=H.getDate(),v=H.getMonth(),r.attr("data-date",H.toDateString()),r.find(".heading > .number").text(u),r.find(".heading > .month").toggle(0===b&&0===c||1===u).text((0===v&&1===u?g.year.format(t)+" ":"")+g.monthNames[v]),s.toggleClass("current-month",v===C),s.toggleClass("current",u===F&&v===D&&t===E),s.toggleClass("past",z>H),s.toggleClass("future",H>z),r.find(".events").empty(),H.addDays(1)})}),b.withHeader&&(this.$caption.text(g.yearMonth.format(B,C+1)),this.$todayBtn.toggleClass("disabled",C===D));var I,J,K=(this.events,this.calendars);a.each(this.events,function(b,c){c.start>=A&&c.start<=G&&(r=x.filter('[data-date="'+c.start.toDateString()+'"]'),r.length&&(I=a('<div data-id="'+c.id+'" class="event" title="'+c.desc+'"><span class="time">'+c.start.format("hh:mm")+'</span> <span class="title">'+c.title+"</span></div>"),I.find(".time").toggle(!c.allDay),I.data("event",c),c.calendar&&(J=K[c.calendar],J&&I.data("calendar",J).css("background-color",J.color)),r.find(".events").append(I)))}),b.dragThenDrop&&k.find(".event").droppable({target:x,container:k,flex:!0,start:function(){j.addClass("event-dragging")},drop:function(a){var b=a.element.data("event"),d=a.target.attr("data-date"),e=b.start.clone();if(e.toDateString()!=d&&(d=new Date(d),d.setHours(e.getHours()),d.setMinutes(e.getMinutes()),d.setSeconds(e.getSeconds()),c.callEvent("beforeChange",{event:b,change:"start",to:d}))){var f=b.end.clone();b.end.addMilliseconds(b.end.getTime()-e.getTime()),b.start=d,a.target.find(".events").append(a.element),c.callEvent("change",{data:c.data,changes:[{event:b,changes:[{change:"start",from:e,to:b.start},{change:"end",from:f,to:b.end}]}]})}},finish:function(){j.removeClass("event-dragging")}})},g.prototype.callEvent=function(a,b){var c=this.$.callEvent(a+"."+this.name,b,this);return!(void 0!=c.result&&!c.result)},a.fn.calendar=function(b){return this.each(function(){var d=a(this),e=d.data(c),f="object"==typeof b&&b;e||d.data(c,e=new g(this,f)),"string"==typeof b&&e[b]()})},a.fn.calendar.Constructor=g}(jQuery,window);