/*!
 * ZUI - v1.2.0-beta - 2014-10-30
 * http://zui.sexy
 * GitHub: https://github.com/easysoft/zui.git 
 * Copyright (c) 2014 cnezsoft.com; Licensed MIT
 */

+function(a){"use strict";var b="zui.datatable",c=function(c,d){this.name=b,this.$=a(c),this.isTable="TABLE"===this.$[0].tagName,this.isTable?this.id="datatable-"+(this.$.attr("id")||a.uuid()):(this.$datatable=this.$.addClass("datatable"),this.$.attr("id")?this.id=this.$.attr("id"):(this.id="datatable-"+a.uuid(),this.$.attr("id",this.id))),this.getOptions(d),this.load(),this.callEvent("ready")};c.DEFAULTS={checkable:!1,checkByClickRow:!0,checkedClass:"active",sortable:!1,fixedHeader:!0,fixedHeaderOffset:0,fixedLeftWidth:"30%",fixedRightWidth:"30%",flexHeadDrag:!0,rowHover:!0,colHover:!0,hoverClass:"hover",colHoverClass:"col-hover",minColWidth:20,minFixedLeftWidth:200,minFixedRightWidth:200,minFlexAreaWidth:200},c.prototype.getOptions=function(b){var d=this.$,b=a.extend({},c.DEFAULTS,this.$.data(),b);b.tableClass=b.tableClass||"",b.tableClass=" "+b.tableClass+" table-datatable",d.hasClass("table-bordered")&&(b.tableClass+=" table-bordered"),(d.hasClass("table-hover")||b.rowHover)&&(b.tableClass+=" table-hover"),d.hasClass("table-striped")&&(b.tableClass+=" table-striped"),d.hasClass("table-condensed")&&(b.tableClass+=" table-condensed"),d.hasClass("table-fixed")&&(b.tableClass+=" table-fixed"),this.options=b},c.prototype.load=function(b){var c=this.options,d=this.$;if(b=b||c.data,!b){if(!this.isTable)throw new Error("No data avaliable!");b={cols:[],rows:[]};var e,f,g,h,i=b.cols,j=b.rows;d.find("thead > tr:first").children("th").each(function(){e=a(this),i.push(a.extend({text:e.html(),flex:!1||e.hasClass("flex-col"),width:"auto",cssClass:e.attr("class"),css:e.attr("style"),type:"string",sort:!e.hasClass("sort-disabled")},e.data()))}),d.find("tbody > tr").each(function(){f=a(this),h=a.extend({data:[],checked:!1,cssClass:f.attr("class"),css:f.attr("style"),id:f.attr("id")},f.data()),f.children("td").each(function(){g=a(this),h.data.push(a.extend({cssClass:g.attr("class"),css:g.attr("style"),text:g.html()},g.data()))}),j.push(h)});var k=d.find("tfoot");k.length&&(b.footer=a('<table class="table'+c.tableClass+'"></table>').append(k))}b.flexStart=-1,b.flexEnd=-1;var i=b.cols;b.colsLength=i.length;for(var l=0;l<b.colsLength;++l){var m=i[l];m.flex&&(b.flexStart<0&&(b.flexStart=l),b.flexEnd=l)}0===b.flexStart&&b.flexEnd===i.length&&(b.flexStart=-1,b.flexEnd=-1),b.flexArea=b.flexStart>=0,b.fixedRight=b.flexEnd>=0&&b.flexEnd<i.length-1,b.fixedLeft=b.flexStart>0,b.flexStart<0&&b.flexEnd<0&&(b.fixedLeft=!0,b.flexStart=i.length,b.flexEnd=i.length),this.data=b,this.callEvent("afterLoad",{data:b}),this.render()},c.prototype.render=function(){var b,c,d,e,f=this,g=f.$datatable||(f.isTable?a('<div class="datatable" id="'+f.id+'"/>'):f.$datatable),h=f.options,i=f.data,j=f.data.cols,k=f.data.rows,l=h.checkable,m='<div class="datatable-rows-span datatable-span"><div class="datatable-wrapper"><table class="table"></table></div></div>',n='<div class="datatable-head-span datatable-span"><div class="datatable-wrapper"><table class="table"><thead></thead></table></div></div>';g.empty(),g.toggleClass("sortable",h.sortable);var o,p,q,r=a('<div class="datatable-head"/>');for(b=a("<tr/>"),d=a("<tr/>"),e=a("<tr/>"),c=0;c<j.length;c++)q=j[c],o=c<i.flexStart?b:c>=i.flexStart&&c<=i.flexEnd?e:d,p=a("<th/>"),p.toggleClass("sort-down","down"===q.sort).toggleClass("sort-up","up"===q.sort).toggleClass("sort-disabled",q.sort===!1),p.addClass(q.cssClass).addClass(q.colClass).html(q.text).attr({"data-index":c,"data-type":q.type,style:q.css}),0===c&&l&&o.append('<th data-index="check" class="check-all check-btn"><i class="icon-check-empty"></i></th>'),o.append(p);var s;i.fixedLeft&&(s=a(n),s.addClass("fixed-left").find("table").addClass(h.tableClass).find("thead").append(b),r.append(s)),i.flexArea&&(s=a(n),s.addClass("flexarea").find(".datatable-wrapper").append('<div class="scrolled-shadow scrolled-in-shadow"></div><div class="scrolled-shadow scrolled-out-shadow"></div>').find("table").addClass(h.tableClass).find("thead").append(e),r.append(s)),i.fixedRight&&(s=a(n),s.addClass("fixed-right").find("table").addClass(h.tableClass).find("thead").append(d),r.append(s)),g.append(r);var t,u,v,w,x,y,z,A=a('<div class="datatable-rows">'),B=k.length;b=a("<tbody/>"),d=a("<tbody/>"),e=a("<tbody/>");for(var C=0;B>C;++C){for(x=k[C],"undefined"==typeof x.id&&(x.id=C),x.index=C,t=a("<tr/>"),t.addClass(x.cssClass).toggleClass(h.checkedClass,x.checked).attr({"data-index":C,"data-id":x.id}),u=t.clone(),v=t.clone(),z=x.data.length,c=0;z>c;++c)y=x.data[c],o=c<i.flexStart?t:c>=i.flexStart&&c<=i.flexEnd?u:v,a.isPlainObject(y)||(y={text:y,row:C,index:c},x.data[c]=y),w=a("<td/>"),w.html(y.text).addClass(y.cssClass).addClass(j[c].colClass).attr({"data-row":C,"data-index":c,"data-flex":!1,"data-type":j[c].type,style:y.css}),0===c&&l&&o.append('<td data-index="check" class="check-row check-btn"><i class="icon-check-empty"></i></td>'),o.append(w);b.append(t),e.append(u),d.append(v)}var D;i.fixedLeft&&(D=a(m),D.addClass("fixed-left").find("table").addClass(h.tableClass).append(b),A.append(D)),i.flexArea&&(D=a(m),D.addClass("flexarea").find(".datatable-wrapper").append('<div class="scrolled-shadow scrolled-in-shadow"></div><div class="scrolled-shadow scrolled-out-shadow"></div><div class="scroll-slide"><div class="bar"></div></div>').find("table").addClass(h.tableClass).append(e),A.append(D)),i.fixedRight&&(D=a(m),D.addClass("fixed-right").find("table").addClass(h.tableClass).append(d),A.append(D)),g.append(A),i.footer&&g.append(a('<div class="datatable-footer"/>').append(i.footer)),f.$datatable=g,f.isTable&&f.$.attr("data-datatable-id",this.id).hide().after(g),f.bindEvents(),this.refreshSize(),this.callEvent("render")},c.prototype.bindEvents=function(){var b=this,c=this.data,d=this.options,e=this.$datatable,f=(b.$dataSpans=e.children(".datatable-head, .datatable-rows").find(".datatable-span"),b.$rowsSpans=e.children(".datatable-rows").children(".datatable-rows-span")),g=b.$headSpans=e.children(".datatable-head").children(".datatable-head-span"),h=b.$cells=b.$dataSpans.find("td, th"),i=b.$dataCells=h.filter("td"),j=(b.$headCells=h.filter("th"),b.$rows=b.$rowsSpans.find(".table > tbody > tr"));if(d.rowHover){var k=d.hoverClass;f.on("mouseenter","td",function(){i.filter("."+k).removeClass(k),j.filter("."+k).removeClass(k),j.filter('[data-index="'+a(this).addClass(k).closest("tr").data("index")+'"]').addClass(k)}).on("mouseleave","td",function(){i.filter("."+k).removeClass(k),j.filter("."+k).removeClass(k)})}if(d.colHover){var l=d.colHoverClass;g.on("mouseenter","th",function(){h.filter("."+l).removeClass(l),h.filter('[data-index="'+a(this).data("index")+'"]').addClass(l)}).on("mouseleave","th",function(){h.filter("."+l).removeClass(l)})}if(c.flexArea){var m,n,o,p,q,r,s,t=e.find(".scroll-slide"),u=e.find(".datatable-span.flexarea .table"),v=e.find(".datatable-rows-span.flexarea .table"),w=t.children(".bar"),x=b.id+"_scrollOffset";b.width=e.width(),e.resize(function(){b.width=e.width()});var y=function(a,b){q=Math.max(0,Math.min(m-n,a)),b||e.addClass("scrolling"),w.css("left",q),s=0-Math.floor((o-m)*q/(m-n)),u.css("left",s),p=q,e.toggleClass("scrolled-in",q>2).toggleClass("scrolled-out",m-n-2>q),store.pageSet(x,q)},z=function(){m=t.width(),o=v.width(),n=Math.floor(m*m/o),w.css("width",n),v.css("min-width",m),e.toggleClass("show-scroll-slide",o>m),r||m===n||(r=!0,y(store.pageGet(x,0),!0)),e.hasClass("size-changing")&&y(q,!0)};t.resize(z),v.resize(z),z();var A={move:!1,stopPropagation:!0,drag:function(a){y(w.position().left+a.smallOffset.x*(a.element.hasClass("bar")?1:-1))},finish:function(){e.removeClass("scrolling")}};w.draggable(A),d.flexHeadDrag&&e.find(".datatable-head-span.flexarea").draggable(A),t.mousedown(function(a){var b=a.pageX-t.offset().left;y(b-n/2)})}if(d.checkable){var B,C=b.id+"_checkedStatus",D=d.checkedClass,E=function(){var d=f.first().find(".table > tbody > tr"),e=d.filter("."+D),h={checkedAll:d.length===e.length&&e.length>0,checks:e.map(function(){return B=a(this).data("id")}).toArray()};a.each(c.rows,function(b,c){c.checked=a.inArray(c.id,h.checks)>-1}),g.find(".check-all").toggleClass("checked",h.checkedAll),store.pageSet(C,h),b.callEvent("checksChanged",{checks:h})};this.$rowsSpans.on("click",d.checkByClickRow?"tr":".check-row",function(){j.filter('[data-index="'+a(this).closest("tr").data("index")+'"]').toggleClass(D),E()}),this.$datatable.on("click",".check-all",function(){j.toggleClass(D,a(this).toggleClass("checked").hasClass("checked")),E()}).on("click",".check-none",function(){j.toggleClass(D,!1),E()}).on("click",".check-inverse",function(){j.toggleClass(D),E()});var F=store.pageGet(C);F&&(g.find(".check-all").toggleClass("checked",F.checkedAll),F.checkedAll?j.addClass(D):(j.removeClass(D),a.each(F.checks,function(a,b){j.filter('[data-id="'+b+'"]').addClass(D)})),F.checks.length&&b.callEvent("checksChanged",{checks:F}))}d.sortable&&g.on("click","th:not(.sort-disabled, .check-btn)",function(){e.hasClass("size-changing")||b.sortTable(a(this))})},c.prototype.sortTable=function(b){var c=this.id+"_datatableSorter",d=store.pageGet(c);if(b||(b=d?this.$headCells.filter('[data-index="'+d.index+'"]').addClass("sort-"+d.type):this.$headCells.filter(".sort-up, .sort-down").first()),b.length){var e,f,g,h=this.data,i=h.cols,j=h.rows,k=this.$headCells;e=!b.hasClass("sort-up"),k.removeClass("sort-up sort-down"),b.addClass(e?"sort-up":"sort-down"),g=b.data("index"),e=b.hasClass("sort-up"),a.each(i,function(a,b){a==g||"up"!==b.sort&&"down"!==b.sort?a==g&&(b.sort=e?"up":"down",f=b.type):b.sort=!0});var l,m,n,o=this.$dataCells.filter('[data-index="'+g+'"]');j.sort(function(a,b){return a=a.data[g],b=b.data[g],l=o.filter('[data-row="'+a.row+'"]').text(),m=o.filter('[data-row="'+b.row+'"]').text(),"number"===f?(l=parseFloat(l),m=parseFloat(m)):"date"===f?(l=Date.parse(l),m=Date.parse(m)):(l=l.toLowerCase(),m=m.toLowerCase()),n=l>m?1:m>l?-1:0,e&&(n=-1*n),n});var p,q,r,s=this.$rows,t=[];a.each(j,function(b,c){p=s.filter('[data-index="'+c.index+'"]'),p.each(function(b){r=a(this),q=t[b],q?q.after(r):r.parent().prepend(r),t[b]=r})});var d={index:g,type:e?"up":"down"};store.pageSet(c,d),this.callEvent("sort",{sorter:d})}},c.prototype.refreshSize=function(){var b=this.$datatable,c=this.options,d=this.data.rows,e=this.data.cols;b.find(".datatable-span.fixed-left").css("width",c.fixedLeftWidth),b.find(".datatable-span.fixed-right").css("width",c.fixedRightWidth);for(var f=function(b){var c=0;return b.css("height","auto"),b.each(function(){c=Math.max(c,a(this).height())}),c},g=this.$dataCells,h=this.$cells,i=this.$headCells,j=0;j<e.length;++j)h.filter('[data-index="'+j+'"]').css("width",e[j].width);i.height(f(i));for(var k,j=0;j<d.length;++j)k=g.filter('[data-row="'+j+'"]'),k.height(f(k))},c.prototype.callEvent=function(a,b){var c=this.$.callEvent(a+"."+this.name,b,this).result;return!(void 0!=c&&!c)},a.fn.datatable=function(d){return this.each(function(){var e=a(this),f=e.data(b),g="object"==typeof d&&d;f||e.data(b,f=new c(this,g)),"string"==typeof d&&f[d]()})},a.fn.datatable.Constructor=c}(jQuery,window);